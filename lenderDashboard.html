<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lender Dashboard - EcoSwap</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-50 dark:bg-[#1e3a8a] text-gray-800 dark:text-gray-200 font-sans">

<main class="p-6 max-w-4xl mx-auto">
  <h2 class="text-2xl font-bold mb-4">Pending Requests</h2>
  <input type="text" id="searchInput" placeholder="Search requests..." class="mb-4 p-2 border rounded w-full"/>
  <div id="requestsList" class="space-y-4"></div>
</main>

<script>
const requestsDiv = document.getElementById("requestsList");
const searchInput = document.getElementById("searchInput");
const lenderName = "LenderName"; // Your lender info
const providerPhone = "1234567890";
const providerAddress = "Some Address";

// Load requests from localStorage (reqJeevitha.html stores them)
let requests = JSON.parse(localStorage.getItem('requests') || '[]');

// BroadcastChannel to sync updates with reqJeevitha.html
const channel = new BroadcastChannel('requests_channel');

// Render function
function renderRequests() {
  const filter = searchInput.value.toLowerCase();
  requestsDiv.innerHTML = "";

  const pendingRequests = requests.filter(r => (!r.status || r.status === "pending") &&
    r.itemName.toLowerCase().includes(filter));

  if (pendingRequests.length === 0) {
    requestsDiv.innerHTML = `<p>No pending requests found.</p>`;
    return;
  }

  pendingRequests.forEach(req => {
    const div = document.createElement("div");
    div.className = "p-4 bg-white dark:bg-gray-800 rounded shadow space-y-2";

    div.innerHTML = `
      <p><strong>Requester:</strong> ${req.requesterId}</p>
      <p><strong>Item:</strong> ${req.itemName}</p>
      <p><strong>Description:</strong> ${req.description || "-"}</p>
      <div class="flex gap-2 mt-2">
        <button class="accept-btn bg-green-500 text-white px-3 py-1 rounded">Accept</button>
        <button class="reject-btn bg-red-500 text-white px-3 py-1 rounded">Reject</button>
      </div>
    `;

    requestsDiv.appendChild(div);

    div.querySelector(".accept-btn").onclick = () => updateRequest(req.id, "accepted");
    div.querySelector(".reject-btn").onclick = () => updateRequest(req.id, "rejected");
  });
}

// Accept / Reject handler
function updateRequest(id, status) {
  const idx = requests.findIndex(r => r.id === id);
  if (idx === -1) return;

  requests[idx].status = status;
  if (status === "accepted") {
    requests[idx].acceptedBy = lenderName;
    requests[idx].providerPhone = providerPhone;
    requests[idx].providerAddress = providerAddress;
  }

  // Save updated requests to localStorage
  localStorage.setItem('requests', JSON.stringify(requests));

  // Broadcast update to reqJeevitha.html
  channel.postMessage(requests[idx]);

  renderRequests();
}

// Listen for updates from reqJeevitha.html
channel.onmessage = (event) => {
  const updatedReq = event.data;
  const idx = requests.findIndex(r => r.id === updatedReq.id);
  if (idx !== -1) requests[idx] = updatedReq;
  else requests.push(updatedReq);
  localStorage.setItem('requests', JSON.stringify(requests));
  renderRequests();
};

// Search filter
searchInput.addEventListener('input', renderRequests);

// Initial render
renderRequests();
</script>
</body>
</html>
