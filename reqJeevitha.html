<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Requested Items - EcoSwap</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-50 dark:bg-[#1e3a8a] text-gray-800 dark:text-gray-200 font-sans">
  <main class="p-6 max-w-4xl mx-auto">
    <h2 class="text-2xl font-bold mb-4">Your Requested Items</h2>
    <div id="requestedItems" class="space-y-4"></div>
  </main>

  <script>
    const requestedItemsDiv = document.getElementById("requestedItems");
    let requests = []; // Store requests locally

    // --- Load initial requests from server ---
    async function loadRequestedItems() {
      const res = await fetch("http://127.0.0.1:5000/api/requests");
      requests = await res.json();

      // Save initial requests to localStorage
      localStorage.setItem('requests', JSON.stringify(requests));

      renderRequests();
    }

    // --- Render function ---
    function renderRequests() {
      requestedItemsDiv.innerHTML = "";

      if (requests.length === 0) {
        requestedItemsDiv.innerHTML = `<p>No requested items yet.</p>`;
        return;
      }

      requests.forEach(req => {
        const div = document.createElement("div");
        div.className = "p-4 bg-white dark:bg-gray-800 rounded shadow space-y-2";
        div.innerHTML = `
          <p><strong>Item:</strong> ${req.itemName}</p>
          <p><strong>Description:</strong> ${req.description || "-"}</p>
          <p><strong>Status:</strong> 
            <span class="${req.status === 'accepted' ? 'text-green-600 font-bold' : req.status === 'rejected' ? 'text-red-600 font-bold' : 'text-yellow-600 font-bold'}">
              ${req.status || 'pending'}
            </span>
          </p>
          ${req.status === 'accepted' ? `<p><strong>Lender:</strong> ${req.acceptedBy}</p>
          <p><strong>Phone:</strong> ${req.providerPhone}</p>
          <p><strong>Address:</strong> ${req.providerAddress}</p>` : ''}
        `;
        requestedItemsDiv.appendChild(div);
      });
    }

    // --- BroadcastChannel for live updates from lenderDashboard ---
    const channel = new BroadcastChannel('requests_channel');

    channel.onmessage = (event) => {
      const updatedReq = event.data;
      const idx = requests.findIndex(r => r.id === updatedReq.id);

      if (idx !== -1) {
        requests[idx] = updatedReq; // update existing request
      } else {
        requests.push(updatedReq); // add new request
      }

      // Save updated requests to localStorage
      localStorage.setItem('requests', JSON.stringify(requests));

      renderRequests();
    };

    // --- Initial load ---
    loadRequestedItems();
    
  </script>
</body>
</html>
